# Karpenter Provisioner for general CPU workloads (gateway, interceptor)
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: hypergraph-cpu
spec:
  template:
    metadata:
      labels:
        workload: general
    spec:
      # Customize requirements as needed for your CPU instance families
      requirements:
        - key: "kubernetes.io/arch"
          operator: In
          values: ["amd64", "arm64"]
        - key: "karpenter.k8s.aws/instance-family"
          operator: In
          values: ["c5", "c6i", "m5", "m6i"]
      nodeClassRef:
        name: hypergraph-cpu
  disruption:
    consolidateAfter: 30s
    # Uncomment to allow voluntary disruption during business hours
    # budgets:
    # - nodes: "10%"
  limits:
    cpu: "1000"
    memory: "2048Gi"
  # TTL to scale to zero when empty
  # expiration:
  #   ttlSecondsAfterEmpty: 300
---
apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: hypergraph-cpu
spec:
  # Placeholders; set by platform team
  subnetSelectorTerms:
    - tags:
        # "kubernetes.io/cluster/<your-cluster-name>": "owned"
        # "kubernetes.io/role/internal-elb": "1"
        {}
  securityGroupSelectorTerms:
    - tags:
        # "kubernetes.io/cluster/<your-cluster-name>": "owned"
        {}
  amiFamily: AL2
  role: "KarpenterNodeRole-REPLACE"
  tags:
    workload: general
  # Uncomment for Spot/OD mix
  # detailedMonitoring: true
  # blockDeviceMappings:
  #   - deviceName: /dev/xvda
  #     ebs:
  #       volumeSize: 100Gi
  #       volumeType: gp3
---
# GPU NodePool for explainer (enable when GPU path required)
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: hypergraph-gpu
spec:
  template:
    metadata:
      labels:
        workload: explainer
    spec:
      requirements:
        - key: "kubernetes.io/arch"
          operator: In
          values: ["amd64"]
        - key: "k8s.amazonaws.com/accelerator"
          operator: Exists
        - key: "karpenter.k8s.aws/instance-family"
          operator: In
          values: ["p3", "p4d", "g5", "p5"] # include h100 families when available
      kubelet:
        # Allow scheduling GPU device plugin DaemonSet
        evictionSoft:
          memory.available: "500Mi"
      nodeClassRef:
        name: hypergraph-gpu
  disruption:
    consolidateAfter: 60s
  # Scale to zero if unused
  # expiration:
  #   ttlSecondsAfterEmpty: 300
---
apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: hypergraph-gpu
spec:
  subnetSelectorTerms:
    - tags: {}
  securityGroupSelectorTerms:
    - tags: {}
  amiFamily: AL2
  role: "KarpenterNodeRole-REPLACE"
  tags:
    workload: explainer
  # Launch template fields for GPU
  # instanceProfile: "REPLACE-WITH-INSTANCE-PROFILE"
  # capacityType: "spot" # or "on-demand"
  # Interruptions/disruption policies example:
  # interruptionHandling:
  #   consolidateAfter: 180s
